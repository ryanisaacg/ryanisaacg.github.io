<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="/post.css" />
        
        <link rel="alternate" type="application/atom+xml" href="/rss.xml" title="RSS feed">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title> Hot Reloading for Rust Gamedev </title>
<meta property="og:title" content="Hot Reloading for Rust Gamedev">

<meta name="description" content="true">
<meta property="og:description" content="true">

<meta name="theme-color" content="#7d7fff">


    </head>
    <body>
        <header>
            <div class="page-header">
    <strong>Ryan Goldstein</strong>
    <div class="header-links">
        <a href="/">/home</a>
        <a href="/posts">/all posts</a>
    </div>
</div>

            
                <aside class="callout-note">
                    <p>
                        This post is a draft. Please don't share it with anyone else; if I didn't send you the link directly, you're probably not supposed to be seeing it!
                    </p>
                </aside>
            

            <h1> Hot Reloading for Rust Gamedev </h1>
            <small> 14 Aug  2025 </small>
        </header>
        <article>
            <p>I used to think hot reloading was something only “managed” languages could do, not “compiled” languages. When I change a React component it can update on the page; when I change a line of code in a Rust daemon I have to kill the program and bring it back up. This makes writing games in the latter category of languages somewhat painful. Games tend to be highly stateful; if a bit of behavior only triggers in a particular state, it can be annoying to return to that state after relaunching the game. For example, if you’re tweaking font size in a dialogue system, you’ll need to re-initiate a dialogue each time you close or open the game.</p>
<p>Last year I was working on Felt, my hobby programming language, when I had a realization. Felt compiles to WebAssembly (WASM); in WASM the code for your application is entirely separate from its memory<sup class="footnote-ref"><a href="#fn1" id="fnref1" aria-describedby="footnotes-label" role="doc-noteref">[1]</a></sup>. It’s really easy to replace the code and keep the memory the same; as long as your data structures stay the same shape, this gives you hot reloading for free. I made a demo in Felt where a single keystroke recompiled the game and reloaded it live, allowing you to change all the rendering or game logic without having to relaunch or replay anything.</p>
<p>This year I’ve been working on Felt a lot less. I’m currently making a small game in Rust to shake some of the small-r rust off my gamedev muscles. Pretty early on I ran into some font layout bugs in my new game engine, and wanted seamless code reloading. Is such a thing possible in Rust?</p>
<p>It is, if we take advantage of dynamic libraries. There are two ways to link binary blobs of code together: static linking (where we concatenate the binaries into one final product) and dynamic linking (where the libraries are found on-disk each time the program launches). By default Rust statically links crates together, which means we can’t easily load in a new version of our game’s logic. But if we dynamically link the crates, we can reload the dynamic library.</p>
<p>At first I tried the <a href="https://docs.rs/hot-lib-reloader/latest/hot_lib_reloader/"><code>hot-lib-reloader</code> crate</a>. It seemed promising, and has a nice API; take this example from their docs:</p>
<pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[hot_lib_reloader::hot_module(dylib = <span class="token string">"lib"</span>)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">hot_lib</span> <span class="token punctuation">{</span>
    <span class="token comment">// Reads public no_mangle functions from lib.rs and  generates hot-reloadable</span>
    <span class="token comment">// wrapper functions with the same signature inside this module.</span>
    <span class="token comment">// Note that this path relative to the project root (or absolute)</span>
    <span class="token macro property">hot_functions_from_file!</span><span class="token punctuation">(</span><span class="token string">"lib/src/lib.rs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Because we generate functions with the exact same signatures,</span>
    <span class="token comment">// we need to import types used</span>
    <span class="token keyword">pub</span> <span class="token keyword">use</span> <span class="token namespace">lib<span class="token punctuation">::</span></span><span class="token class-name">State</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> state <span class="token operator">=</span> <span class="token namespace">hot_lib<span class="token punctuation">::</span></span><span class="token class-name">State</span> <span class="token punctuation">{</span> counter<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// Running in a loop so you can modify the code and see the effects</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token namespace">hot_lib<span class="token punctuation">::</span></span><span class="token function">step</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>That macro automatically handles a bunch of binding work for us. Unfortunately, it also doesn’t work. Rust 2024 requires that the <code>#[no_mangle]</code> attribute be decorated as <code>unsafe</code> (because it allows a bunch of link-time madness), so it now looks like <code>#[unsafe(no_mangle)]</code>. <code>hot-lib-reloader</code> doesn’t understand this syntax. There are some open PRs to add it, but I don’t really want to get that far into the weeds. Instead I think it’s best if we cut through the magic and do the bindings ourselves, the simple way.</p>
<p>I have my game’s logic defines in a separate crate called <code>game-core</code>, with the following stanza in its <code>Cargo.toml</code>:</p>
<pre class="language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span>
<span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"rlib"</span><span class="token punctuation">,</span> <span class="token string">"dylib"</span><span class="token punctuation">]</span></code></pre>
<p>The lib exports some functions that look like this:</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">async_ffi<span class="token punctuation">::</span></span><span class="token class-name">LocalFfiFuture</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">GameState</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[unsafe(no_mangle)]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span>venus<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">mut</span> <span class="token class-name">Venus</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">LocalFfiFuture</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">GameState</span><span class="token operator">>></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[unsafe(no_mangle)]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">tick</span><span class="token punctuation">(</span>venus<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Venus</span><span class="token punctuation">,</span> game_state<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">GameState</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre>
<p>Then the dev executable looks like this:</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">async_ffi<span class="token punctuation">::</span></span><span class="token class-name">LocalFfiFuture</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">libloading<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Library</span><span class="token punctuation">,</span> library_filename<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">venus<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Color</span><span class="token punctuation">,</span> <span class="token class-name">Venus</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">GameState</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token type-definition class-name">Init</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span><span class="token punctuation">(</span>venus<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Venus</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">LocalFfiFuture</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">GameState</span><span class="token operator">>></span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token type-definition class-name">Tick</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span><span class="token punctuation">(</span>venus<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Venus</span><span class="token punctuation">,</span> game_state<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">GameState</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Venus</span><span class="token punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span>
        <span class="token keyword">async</span> <span class="token operator">|</span>venus<span class="token operator">|</span> <span class="token function">game</span><span class="token punctuation">(</span>venus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token namespace">venus<span class="token punctuation">::</span></span><span class="token class-name">Settings</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">game</span><span class="token punctuation">(</span><span class="token keyword">mut</span> venus<span class="token punctuation">:</span> <span class="token class-name">Venus</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token function">library_filename</span><span class="token punctuation">(</span><span class="token string">"game_core"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_owned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> filename <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cargo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token string">"build"</span><span class="token punctuation">,</span> <span class="token string">"-p"</span><span class="token punctuation">,</span> <span class="token string">"game-core"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"target/debug/{filename}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> lib <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Library</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> init<span class="token punctuation">:</span> <span class="token namespace">libloading<span class="token punctuation">::</span></span><span class="token class-name">Symbol</span><span class="token operator">&lt;</span><span class="token class-name">Init</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> lib<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">b"init"</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> tick<span class="token punctuation">:</span> <span class="token namespace">libloading<span class="token punctuation">::</span></span><span class="token class-name">Symbol</span><span class="token operator">&lt;</span><span class="token class-name">Tick</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> lib<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">b"tick"</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> game_state <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> venus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> venus<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> game_state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> venus<span class="token punctuation">.</span><span class="token function">is_key_pressed</span><span class="token punctuation">(</span><span class="token namespace">venus<span class="token punctuation">::</span></span><span class="token class-name">Key</span><span class="token punctuation">::</span><span class="token constant">F5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            venus<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token constant">WHITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            venus<span class="token punctuation">.</span><span class="token function">end_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token function">cargo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token string">"build"</span><span class="token punctuation">,</span> <span class="token string">"-p"</span><span class="token punctuation">,</span> <span class="token string">"game-core"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            lib <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Library</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            init <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> lib<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">b"init"</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            tick <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> lib<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">b"tick"</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> venus<span class="token punctuation">.</span><span class="token function">is_key_pressed</span><span class="token punctuation">(</span><span class="token namespace">venus<span class="token punctuation">::</span></span><span class="token class-name">Key</span><span class="token punctuation">::</span><span class="token constant">F6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            game_state <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> venus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        venus<span class="token punctuation">.</span><span class="token function">end_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">cargo</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Building project..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> exit_status <span class="token operator">=</span> <span class="token class-name">Command</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"cargo"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> exit_status<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token macro property">bail!</span><span class="token punctuation">(</span><span class="token string">"Failed to compile project"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>If you press F5, the screen clears out white and the game is re-compiled and then reloaded. If you press F6, the game restarts. I was pretty surprised at how simple and easy this was!</p>
<p>There are caveats, the major one being that any kind of static state in the <code>game-core</code> lib won’t persist between reloads. This rules out using a library like <a href="https://macroquad.rs/"><code>macroquad</code></a> which has a lot of implicit global state; I happen to be crotchety and prone to writing my own game engines regardless. It also breaks font rendering in my game, for reasons I haven’t yet debugged (when you reload, characters that haven’t been rasterized and cached yet render as a square instead).</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>That is to say it does not follow the <a href="https://en.wikipedia.org/wiki/Von_Neumann_architecture">von Neumann Architecture</a> that most other programs do, with a flat address space for both code and data. <a href="#fnref1" aria-label="Back to reference 1" role="doc-backlink" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

        </article>
    </body>
</html>

